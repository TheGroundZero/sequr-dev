<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><title itemprop=name>Automating my lights at the toilet room :: Sequr (dev)</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=robots content="noodp, noydir"><meta name=googlebot content="noodp, noydir"><link rel=canonical href=https://dev.sequr.be/ itemprop=url><meta name=url content="https://dev.sequr.be/"><link rel=icon href=/favicon.ico><meta itemprop=name content="Sequr (dev)"><meta itemprop=description content="Dev version of sequr.be. This site may break at any time."><meta itemprop=datePublished content="2024-11-20T00:00:00+01:00"><meta itemprop=dateModified content="2024-11-20T00:00:00+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Sequr (dev)"><meta name=twitter:description content="Dev version of sequr.be. This site may break at any time."><meta property="og:url" content="https://dev.sequr.be/"><meta property="og:site_name" content="Sequr (dev)"><meta property="og:title" content="Sequr (dev)"><meta property="og:description" content="Dev version of sequr.be. This site may break at any time."><meta property="og:locale" content="en_us"><meta property="og:type" content="website"><meta name=description content="Dev version of sequr.be. This site may break at any time."><meta itemprop=description content="Dev version of sequr.be. This site may break at any time."><meta property="og:updated_time" content="2024-11-20T00:00:00+01:00"><link rel=sitemap type=application/xml title=Sitemap href=https://dev.sequr.be/sitemap.xml><link href=https://dev.sequr.be/index.xml rel=alternate type=application/rss+xml title="Sequr (dev)"><meta name=apple-mobile-web-app-title content="Sequr (dev)"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><link rel=stylesheet href=/css/bundle.css><script defer type=text/javascript src=/js/bundle.min.145453261a7755f5042a854c4213501d215a8fbe34c08d181c40f803f1315e74.js integrity="sha256-FFRTJhp3VfUEKoVMQhNQHSFaj740wI0YHED4A/ExXnQ=" crossorigin=anonymous></script></head><body class=dark-theme><div class=wrapper><aside class="sidebar h-card background-image"><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class="sidebar-about hcard"><h1 class=brand><a href=https://dev.sequr.be/><img src=/logo.png class="u-logo u-photo" alt="Sequr (dev) brand image">
</a><a href=https://dev.sequr.be/ class="u-url p-org"><h1>Sequr (dev)</h1></a></h1><p class="lead p-note">Dev version of sequr.be. This site may break at any time.</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/about/ title=About>About</a></li><li class=heading><a href=/blog/ title=Blog>Blog</a></li><li class=sub-heading>Recent</li><li class=bullet><a href=https://dev.sequr.be/blog/2024/09/flashing-the-ikea-vindriktning-with-tasmota-and-esphome/ title="Flashing the IKEA Vindriktning with Tasmota and ESPHome">IKEA Vindriktning in HA</a></li><li class=bullet><a href=https://dev.sequr.be/blog/2024/02/home-assistant-container-part-13-vs-code-code-server/ title="Home Assistant Container Part 13: VS Code code-server">HA Containter pt13: VS Code</a></li><li class=bullet><a href=https://dev.sequr.be/blog/2024/02/flash-xiaomi-lywsd03mmc-ble-sensor-with-zigbee-firmware/ title="Flash Xiaomi LYWSD03MMC BLE sensor with Zigbee firmware">Xiaomi LYWSD03MMC with Zigbee</a></li><li class=bullet><a href=https://dev.sequr.be/blog/2023/12/remotely-opening-and-closing-my-gate/ title="Remotely opening and closing my gate">HA gate controller</a></li><li class=bullet><a href=https://dev.sequr.be/blog/2023/10/2-months-in/ title="2 months in">2 months in</a></li><li class=heading><a href=/shoppinglist/ title="Shopping List">Shopping</a></li><li class=heading><a href=/privacy/ title="Privacy Statement">Privacy</a></li></ul></nav><a target=_blank class=social title="RSS Feed" href=/blog/index.xml><svg width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg>
</a><a href=https://bsky.app/profile/sequr.be target=_blank class="u-url social" rel="external noopener me" title=Bluesky><svg width="1.2em" height="1.2em" viewBox="0 0 568 501"><path fill="currentcolor" d="M123.121 33.6637C188.241 82.5526 258.281 181.681 284 234.873c25.719-53.192 95.759-152.3204 160.879-201.2093C491.866-1.61183 568-28.9064 568 57.9464 568 75.2916 558.055 203.659 552.222 224.501c-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281C285.169 375.812 284.017 372.431 284 375.306 283.983 372.431 282.831 375.812 280.369 383.039c-13.43 39.422-65.842 193.273-185.7023 70.281C31.5556 388.56 60.7778 323.8 175.653 304.249 109.933 315.434 36.0535 296.954 15.7778 224.501 9.94525 203.659.0 75.2916.0 57.9464.0-28.9064 76.1345-1.61183 123.121 33.6637z"/></svg></a><a href=https://mastodon-belgium.be/@TerraGloba target=_blank class="u-url social" rel="external noopener me" title=Mastodon><svg width="1.2em" height="1.2em" viewBox="0 0 568 501"><path fill="currentcolor" d="M123.121 33.6637C188.241 82.5526 258.281 181.681 284 234.873c25.719-53.192 95.759-152.3204 160.879-201.2093C491.866-1.61183 568-28.9064 568 57.9464 568 75.2916 558.055 203.659 552.222 224.501c-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281C285.169 375.812 284.017 372.431 284 375.306 283.983 372.431 282.831 375.812 280.369 383.039c-13.43 39.422-65.842 193.273-185.7023 70.281C31.5556 388.56 60.7778 323.8 175.653 304.249 109.933 315.434 36.0535 296.954 15.7778 224.501 9.94525 203.659.0 75.2916.0 57.9464.0-28.9064 76.1345-1.61183 123.121 33.6637z"/></svg></a><a href=https://github.com/TheGroundZero target=_blank class="u-url social" rel="external noopener me" title=Github><svg width="1.2em" height="1.2em" viewBox="0 0 568 501"><path fill="currentcolor" d="M123.121 33.6637C188.241 82.5526 258.281 181.681 284 234.873c25.719-53.192 95.759-152.3204 160.879-201.2093C491.866-1.61183 568-28.9064 568 57.9464 568 75.2916 558.055 203.659 552.222 224.501c-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281C285.169 375.812 284.017 372.431 284 375.306 283.983 372.431 282.831 375.812 280.369 383.039c-13.43 39.422-65.842 193.273-185.7023 70.281C31.5556 388.56 60.7778 323.8 175.653 304.249 109.933 315.434 36.0535 296.954 15.7778 224.501 9.94525 203.659.0 75.2916.0 57.9464.0-28.9064 76.1345-1.61183 123.121 33.6637z"/></svg></a><a href=https://twitter.com/DezeStijn target=_blank class="u-url social" rel="external noopener me" title=Twitter><svg width="1.2em" height="1.2em" viewBox="0 0 568 501"><path fill="currentcolor" d="M123.121 33.6637C188.241 82.5526 258.281 181.681 284 234.873c25.719-53.192 95.759-152.3204 160.879-201.2093C491.866-1.61183 568-28.9064 568 57.9464 568 75.2916 558.055 203.659 552.222 224.501c-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281C285.169 375.812 284.017 372.431 284 375.306 283.983 372.431 282.831 375.812 280.369 383.039c-13.43 39.422-65.842 193.273-185.7023 70.281C31.5556 388.56 60.7778 323.8 175.653 304.249 109.933 315.434 36.0535 296.954 15.7778 224.501 9.94525 203.659.0 75.2916.0 57.9464.0-28.9064 76.1345-1.61183 123.121 33.6637z"/></svg></a><a href=https://ko-fi.com/s4squatch target=_blank class="u-url social" rel="external noopener" title=Kofi><svg width="1.2em" height="1.2em" viewBox="0 0 568 501"><path fill="currentcolor" d="M123.121 33.6637C188.241 82.5526 258.281 181.681 284 234.873c25.719-53.192 95.759-152.3204 160.879-201.2093C491.866-1.61183 568-28.9064 568 57.9464 568 75.2916 558.055 203.659 552.222 224.501c-20.275 72.453-94.155 90.933-159.875 79.748C507.222 323.8 536.444 388.56 473.333 453.32c-119.86 122.992-172.272-30.859-185.702-70.281C285.169 375.812 284.017 372.431 284 375.306 283.983 372.431 282.831 375.812 280.369 383.039c-13.43 39.422-65.842 193.273-185.7023 70.281C31.5556 388.56 60.7778 323.8 175.653 304.249 109.933 315.434 36.0535 296.954 15.7778 224.501 9.94525 203.659.0 75.2916.0 57.9464.0-28.9064 76.1345-1.61183 123.121 33.6637z"/></svg></a><p class=footnote>&copy; 2019
• <a class="p-name u-url" href=https://sequr.be>Sequr</a>
• <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank rel="external noopener">CC BY-NC-SA 4.0</a></p></div></aside><section class="content container"><article class="post h-entry"><header class=info><h1 class="post-title p-name u-url"><a href=https://dev.sequr.be/blog/2021/05/automating-my-lights-at-the-toilet-room/>Automating my lights at the toilet room</a></h1><div class=headline><div><span class="h-card p-author">DezeStijn
</span><span>• </span><time datetime=2021-05-13T00:00:00+0100 class="post-date dt-published">May 13, 2021
</time><time datetime=2021-05-13T00:00:00+0100 class="post-date dt-updated">(May 13, 2021)
</time><span>• </span><span class=reading-time><span>8 mins read</span></span></div><ul class=tags><li class="tag-Home Automation"><a class=p-category href=https://dev.sequr.be/tags/home-automation>Home Automation</a></li></ul></div></header><main class=e-content><h2 id=introduction>Introduction</h2><p>As part of automation all my lights in the house, I also automated the lights in my toilet room.</p><p>To detect if someone&rsquo;s using the toilet I installed a motion sensor.<br>I initially was planning to do this with a door sensor, by quickly realised there would be too many situations in which I&rsquo;d get false triggers or incorrect states.
For example: someone not fully closing the door when using the toilet or someone opening the door when someone&rsquo;s already on the toilet.</p><p>I also added an <em>override</em> using the physical light switch that keeps the lamp on even when the motion sensor didn&rsquo;t detect any motion anymore.
This is mainly to make sure the light wouldn&rsquo;t go out when you&rsquo;re sitting very still.
It also helps with visitors who might not know about the automated lights as the switch&rsquo;s physical position will also reflect the lamp&rsquo;s status,
giving it a &rsquo;natural&rsquo; feeling.</p><p>And I also added a little <em>twist</em>, which I&rsquo;ll explain later in this blog post.</p><p>All of this was done in Node-RED, but it should be possible to do this with Home Assistant automations as well.</p><figure class=center><img src=pexels-roman-odintsov-woman-sitting-on-toilet-bowl-with-smartphone.jpg alt="Image of woman on toilet bowl with smartphone"><figcaption class=center>This isn&rsquo;t me :) kudos to Roman Odintsov on Pexels</figcaption></figure><h2 id=requirements-shopping-list>Requirements (shopping list)</h2><p>Below is a list of the items I used:</p><ul><li><a href=https://shelly.cloud/products/shelly-1l-single-wire-smart-home-automation-relay/ title="Shelly 1L - Product page" rel=external target=_blank>Shelly 1L</a> (<a href=https://shop.shelly.cloud/shelly-1l-wifi-smart-home-automation#407 title="Shelly 1L - European store" rel=external target=_blank>EU</a>/<a href=https://shopusa.shelly.cloud/shelly-1-ul-wifi-smart-home-automation-1#164 title="Shelly 1L UL - US Store" rel=external target=_blank>US</a>)<br>Get the bypass as well.</li><li><a href=https://s.click.aliexpress.com/e/_A6mMhH title="Aqara Motion Sensor" rel=external target=_blank>Aqara Motion Sensor</a></li><li><a href="https://www.phoscon.de/en/conbee2?buy=1#buy" title="ConBee II universal Zigbee USB gateway" rel=external target=_blank>Dresden Elektronik ConBee II</a> (<a href=https://smile.amazon.de/dp/B07PZ7ZHG5 title="ConBee II on Amazon DE" rel=external target=_blank>DE</a>/<a href=https://smile.amazon.com/dp/B07PZ7ZHG5 title="ConBee II on Amazon US" rel=external target=_blank>US</a>)</li></ul><p>If you have Live and Neutral available at the switch or at the light fixture, you could use a Shelly 1 or Shelly 1PM instead.
Then you also won&rsquo;t need the bypass.</p><h2 id=install-the-shelly>Install the Shelly</h2><h3 id=wiring>Wiring</h3><p>I&rsquo;m going to assume you only have a single switch and a single (set of) light(s) in your toilet room.
Check out this <a href=/blog/2020/07/home-automation-intro-into-shelly/#two-way-switch-with-shelly1pm title="Intro into Shelly - Two-way switch with Shelly1(PM) | Sequr.be">wiring diagram</a> if you have a 2-way/3-way/n-way switch.</p><p>First check which wires you have available and whether you have sufficient space to install a Shelly, usually behind the switch plate or in the light fixture.<br>At the switch, you should at least have a Permanent Live wire feeding the switch and a Switched Live wire going from the switch to the lamp.<br>At the ceiling fixture, you should at least have the Switched Live wire and a Neutral wire.
Depending on how your wiring is done, you may have the Permanent Wire going to the switch in here as well.</p><p>If you only have access to Permanent Live and Switched Live where you&rsquo;d like to install the Shelly, you&rsquo;ll need a Shelly 1L.
Most likely you&rsquo;ll also need the Bypass as the power draw of the (LED) lights will be too low, causing a slight glow when the light&rsquo;s supposed to be turned off.<br>If you also have Neutral available, I&rsquo;d advise going for the Shelly 1 or 1PM instead, as you then don&rsquo;t need the Bypass.</p><p>Have a look at the <a href=https://shelly.cloud/knowledge-base/devices/shelly-1l/#wiring title="Shelly 1L - Wiring diagram" rel=external target=_blank>wiring diagram</a> on the Shelly Knowledge Base to see how you should hook up the Shelly.</p><figure class=center><img src=shelly1l_wiring_noneutral.png alt="Wiring diagram for a Shelly 1L with a single switch, no Neutral line, and with bypass"><figcaption class=center>Wiring diagram for the Shelly 1L</figcaption></figure><p><strong>Note:</strong><br>It&rsquo;s important that you connect the switch between the Sx and SW1 terminals when using the Shelly 1L.
Do not connect the switch to the Live wire.</p><p><strong>Note2:</strong><br>The bypass is installed parallel to the lamp, between Switched Live and Neutral.
Don&rsquo;t wire it to Permanent Live or in series to the lamp.</p><h3 id=setup-and-adding-to-home-assistant>Setup and adding to Home Assistant</h3><p>First hook the Shelly up to your WiFi using the <a href=/blog/2021/01/home-automation-shelly-web-ui-method/ title="Shelly Web UI method | Sequr.be">Shelly Web UI Method</a> and add it to the Shelly Cloud and/or Shelly mobile app if you want to.</p><p>Then there&rsquo;s some configurations you can do (from the web ui):</p><ul><li>Give the Shelly a <strong>Device Name</strong> and <strong>Channel Name</strong>.
This will later be reflected in Home Assistant once you integrate the Shelly.</li><li>Set <strong>Button 1 Type</strong> to <strong>Toggle Switch</strong>.
This will allow you to still control the light via the switch should the automation not work and will allow you to turn the light of before the automation does.
You could also set it to <strong>Detached</strong> and only rely on the automation.</li><li><strong>Power on default mode</strong> can be set to <em>Off</em> or <strong>Switch 1</strong> depending on whether you want the light to be off after a power failure or to match the switch state.</li><li>Under <strong>LED Light Control</strong> you can enter <strong>Disable Wi-Fi status light</strong> to save a bit of power as you won&rsquo;t see the Shelly anymore once its behind the switch plate.</li></ul><p>Next, add the Shelly to Home Assistant.</p><ul><li>If you&rsquo;re using the built-in <a href=https://www.home-assistant.io/integrations/shelly/ title="Shelly integration for Home Assistant" rel=external target=_blank>Shelly integration</a> in Home Assistant, I&rsquo;d advise setting up <a href=/blog/2021/03/home-automation-shelly-colot-unicast/ title="Shelly ColoT unicast | Sequr.be">Unicast CoIoT</a> to improve the reliability.</li><li>You can also add the Shelly to Home Assistant using <a href=/blog/2020/10/home-automation-getting-started-with-mqtt-and-home-assistant-and-shelly/ title="Getting started with MQTT and Home Assistant (and Shelly) | Sequr.be">MQTT</a>.</li></ul><h2 id=installing-the-aqara-motion-sensor>Installing the Aqara Motion Sensor</h2><h3 id=physical-installation>Physical installation</h3><p>A motion sensor usually works best if the movement is perpendicular to the motion sensor instead of towards the sensor.
So it&rsquo;s best to install the sensor at a side wall instead of across the door at a height of 1.2 to 2.1 metres.</p><p>The Aqara motion sensor comes with a small foot and some sticky tape, so it very easy to install.</p><figure class=center><img src=toilet-room_motionsensor.png alt="Drawing of a toilet room with a lamp, switch and motion sensor"><figcaption class=center>Sketch of motion sensor installation</figcaption></figure><h3 id=setup-and-adding-to-home-assistant-1>Setup and adding to Home Assistant</h3><p>The Aqara sensors communicate over Zigbee.
That&rsquo;s why you&rsquo;ll need a Zigebee gateway like the Conbee II which will manage the Zigbee devices.</p><p>There are multiple Zigbee integrations available for Home Assistant.
The most popular ones are Zigbee Home Automation (ZHA), deCONZ and Zigbee2MQTT.<br>Each has their own pros and cons.
ZHA is the &ldquo;default&rdquo; zigbee integration and is well supported by HA.
deCONZ require the use of an add-on which uses Phoscon in the back-end and includes firmware-upgrade functionality for the Conbee.
Zigbee2MQTT allows you to use a &lsquo;satellite&rsquo; system to plug your controller into and supports a wide variety of devices.</p><p>I&rsquo;m going with ZHA, but you can pick whatever Zigbee integration you like.</p><h4 id=installing-zigbee-home-automation>Installing Zigbee Home Automation</h4><p>If you haven&rsquo;t installed any Zigbee devices yet, the short description of the installation is:</p><ol><li>Plug the Conbee in your Home Assistant device (Raspberry Pi, Odroid, NUC, server, &mldr;) and reboot it.</li><li>Under <em>Supervisor</em> > <em>System</em> > <em>Host</em> > <em>3-dot menu</em> > <em>Hardware</em> you should be able to identify your ConBee II by dresden elektronik ingenieurtechnik gmbh.</li><li>Go to <em>Configuration</em> > <em>Integrations</em> and click the <em>plus icon</em> to add the <a href=https://www.home-assistant.io/integrations/zha/ title="Zigbee Home Automation integration for Home Assistant" rel=external target=_blank>ZHA</a> integration.</li><li>In the popup, select the serial device path of the Conbee and pick &lsquo;deconz&rsquo; as radio type.<br>When asked for the device path, it&rsquo;s best to pick the path from the <code>/dev/serial/by-id</code> as that always points to the correct device while a path like <code>/dev/ttyUSB0</code> might change upon reboot.</li></ol><h4 id=adding-aqara-motion-sensor-to-zha>Adding Aqara motion sensor to ZHA</h4><p>You may want to temporarily take the motion sensor off its stand/foot and place it closer to the Conbee for this step.</p><ol><li>Go to <em>Configuration</em> > <em>Integrations</em> and press the <em>Configure</em> button under Zigbee Home Automation.</li><li>Click the <em>Add device</em> button at the bottom-right. This will start the search procedure.</li><li>With the Aqara motion sensor near the Conbee (and the battery installed), press and hold the small button for 3 seconds to reset it.</li><li>ZHA should discover the motion sensor and a new device should appear.</li></ol><p>You can now rename the device and its related entities, if you want to.</p><p>The Aqara motion sensor device will have 4 entities:</p><ul><li>Motion detected</li><li>Occupancy detection</li><li>Light sensor</li><li>Battery percentage</li></ul><p>For the next section, we&rsquo;ll be using the &ldquo;Motion detected&rdquo; entity.</p><h2 id=setting-up-the-node-red-flow>Setting up the Node-RED flow</h2><p>There&rsquo;s a few basic things we want to achieve using this Node-RED flow:</p><ul><li>Have lights turn on when motion is detected.</li><li>Turn lights off when there&rsquo;s no motion detected.</li><li>Have the physical switch still work as usual.</li></ul><p>But there are also one few edge cases we want to take into account:</p><ul><li>Don&rsquo;t have the lights turn off after someone enters the toilet soon after someone left (because of the timer).</li></ul><p>The flow I created for this looks like this:</p><figure class=center><img src=nodered-toilet_lamp_motion.png alt="Node-RED flow for toilet room lights"><figcaption class=center>Automatically turn lights on/off with switch override</figcaption></figure><p>It&rsquo;s best to explain this flow from the moment someone leaves the toilet room:</p><ul><li>Once no more motion is detected a 1 minute timer is started.<br>This is more useful with motion sensors that react immediately.<br>The Aqara motions sensors by default have a 1 minute &lsquo;active&rsquo; time.
I.e., when motion is detected, its sensor will keep reading &lsquo;motion detected&rsquo; for one minute, even if the motion only lasted 5 seconds.<ul><li>When the timer runs out, the state of the switch is checked.<ul><li>If the switch is in the &lsquo;off&rsquo; position, the light is turned off.</li><li>If the switch is in the &lsquo;on&rsquo; position, the light stays on as the flow ends.</li></ul></li></ul></li><li>If motion is detected, the light is turned on.<ul><li>Additionally, the timer mentioned above is reset.<br>This will make sure the lights don&rsquo;t turn off if someone enters the toilet room within 1 minute of the previous person leaving.</li></ul></li></ul><p>Below is the JSON code for this flow:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>[{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;ed2e1cbc.08f93&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;server-state-changed&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Movement detected&#34;</span>,<span style=color:#f92672>&#34;server&#34;</span>:<span style=color:#e6db74>&#34;2ce15169.23b9de&#34;</span>,<span style=color:#f92672>&#34;version&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;exposeToHomeAssistant&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;haConfig&#34;</span>:[{<span style=color:#f92672>&#34;property&#34;</span>:<span style=color:#e6db74>&#34;name&#34;</span>,<span style=color:#f92672>&#34;value&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>},{<span style=color:#f92672>&#34;property&#34;</span>:<span style=color:#e6db74>&#34;icon&#34;</span>,<span style=color:#f92672>&#34;value&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>}],<span style=color:#f92672>&#34;entityidfilter&#34;</span>:<span style=color:#e6db74>&#34;binary_sensor.toilet_motion_sensor&#34;</span>,<span style=color:#f92672>&#34;entityidfiltertype&#34;</span>:<span style=color:#e6db74>&#34;exact&#34;</span>,<span style=color:#f92672>&#34;outputinitially&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;state_type&#34;</span>:<span style=color:#e6db74>&#34;habool&#34;</span>,<span style=color:#f92672>&#34;haltifstate&#34;</span>:<span style=color:#e6db74>&#34;true&#34;</span>,<span style=color:#f92672>&#34;halt_if_type&#34;</span>:<span style=color:#e6db74>&#34;bool&#34;</span>,<span style=color:#f92672>&#34;halt_if_compare&#34;</span>:<span style=color:#e6db74>&#34;is&#34;</span>,<span style=color:#f92672>&#34;outputs&#34;</span>:<span style=color:#ae81ff>2</span>,<span style=color:#f92672>&#34;output_only_on_state_change&#34;</span>:<span style=color:#66d9ef>true</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>130</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>240</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[[<span style=color:#e6db74>&#34;695553c8.4a6f0c&#34;</span>,<span style=color:#e6db74>&#34;59bb07c3.40c378&#34;</span>],[<span style=color:#e6db74>&#34;d59925e4.632f2&#34;</span>]]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;59bb07c3.40c378&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;api-call-service&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Turn light on&#34;</span>,<span style=color:#f92672>&#34;server&#34;</span>:<span style=color:#e6db74>&#34;2ce15169.23b9de&#34;</span>,<span style=color:#f92672>&#34;version&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;debugenabled&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;service_domain&#34;</span>:<span style=color:#e6db74>&#34;light&#34;</span>,<span style=color:#f92672>&#34;service&#34;</span>:<span style=color:#e6db74>&#34;turn_on&#34;</span>,<span style=color:#f92672>&#34;entityId&#34;</span>:<span style=color:#e6db74>&#34;light.toilet_lamp&#34;</span>,<span style=color:#f92672>&#34;data&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;dataType&#34;</span>:<span style=color:#e6db74>&#34;json&#34;</span>,<span style=color:#f92672>&#34;mergecontext&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;output_location&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;output_location_type&#34;</span>:<span style=color:#e6db74>&#34;none&#34;</span>,<span style=color:#f92672>&#34;mustacheAltTags&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>370</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>240</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[[]]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;c9acffbd.23f0c8&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;api-call-service&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Turn light off&#34;</span>,<span style=color:#f92672>&#34;server&#34;</span>:<span style=color:#e6db74>&#34;2ce15169.23b9de&#34;</span>,<span style=color:#f92672>&#34;version&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;debugenabled&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;service_domain&#34;</span>:<span style=color:#e6db74>&#34;light&#34;</span>,<span style=color:#f92672>&#34;service&#34;</span>:<span style=color:#e6db74>&#34;turn_off&#34;</span>,<span style=color:#f92672>&#34;entityId&#34;</span>:<span style=color:#e6db74>&#34;light.toilet_lamp&#34;</span>,<span style=color:#f92672>&#34;data&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;dataType&#34;</span>:<span style=color:#e6db74>&#34;json&#34;</span>,<span style=color:#f92672>&#34;mergecontext&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;output_location&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;output_location_type&#34;</span>:<span style=color:#e6db74>&#34;none&#34;</span>,<span style=color:#f92672>&#34;mustacheAltTags&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>710</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>340</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[[]]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;8058a839.544e&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;api-current-state&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Switch on?&#34;</span>,<span style=color:#f92672>&#34;server&#34;</span>:<span style=color:#e6db74>&#34;2ce15169.23b9de&#34;</span>,<span style=color:#f92672>&#34;version&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;outputs&#34;</span>:<span style=color:#ae81ff>2</span>,<span style=color:#f92672>&#34;halt_if&#34;</span>:<span style=color:#e6db74>&#34;true&#34;</span>,<span style=color:#f92672>&#34;halt_if_type&#34;</span>:<span style=color:#e6db74>&#34;bool&#34;</span>,<span style=color:#f92672>&#34;halt_if_compare&#34;</span>:<span style=color:#e6db74>&#34;is&#34;</span>,<span style=color:#f92672>&#34;override_topic&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;entity_id&#34;</span>:<span style=color:#e6db74>&#34;binary_sensor.toilet_switch&#34;</span>,<span style=color:#f92672>&#34;state_type&#34;</span>:<span style=color:#e6db74>&#34;habool&#34;</span>,<span style=color:#f92672>&#34;state_location&#34;</span>:<span style=color:#e6db74>&#34;payload&#34;</span>,<span style=color:#f92672>&#34;override_payload&#34;</span>:<span style=color:#e6db74>&#34;msg&#34;</span>,<span style=color:#f92672>&#34;entity_location&#34;</span>:<span style=color:#e6db74>&#34;data&#34;</span>,<span style=color:#f92672>&#34;override_data&#34;</span>:<span style=color:#e6db74>&#34;msg&#34;</span>,<span style=color:#f92672>&#34;blockInputOverrides&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>530</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>340</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[[],[<span style=color:#e6db74>&#34;c9acffbd.23f0c8&#34;</span>]]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;d59925e4.632f2&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;delay&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;pauseType&#34;</span>:<span style=color:#e6db74>&#34;delay&#34;</span>,<span style=color:#f92672>&#34;timeout&#34;</span>:<span style=color:#e6db74>&#34;1&#34;</span>,<span style=color:#f92672>&#34;timeoutUnits&#34;</span>:<span style=color:#e6db74>&#34;minutes&#34;</span>,<span style=color:#f92672>&#34;rate&#34;</span>:<span style=color:#e6db74>&#34;1&#34;</span>,<span style=color:#f92672>&#34;nbRateUnits&#34;</span>:<span style=color:#e6db74>&#34;1&#34;</span>,<span style=color:#f92672>&#34;rateUnits&#34;</span>:<span style=color:#e6db74>&#34;second&#34;</span>,<span style=color:#f92672>&#34;randomFirst&#34;</span>:<span style=color:#e6db74>&#34;1&#34;</span>,<span style=color:#f92672>&#34;randomLast&#34;</span>:<span style=color:#e6db74>&#34;5&#34;</span>,<span style=color:#f92672>&#34;randomUnits&#34;</span>:<span style=color:#e6db74>&#34;seconds&#34;</span>,<span style=color:#f92672>&#34;drop&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>360</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>340</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[[<span style=color:#e6db74>&#34;8058a839.544e&#34;</span>]]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;695553c8.4a6f0c&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;change&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;rules&#34;</span>:[{<span style=color:#f92672>&#34;t&#34;</span>:<span style=color:#e6db74>&#34;set&#34;</span>,<span style=color:#f92672>&#34;p&#34;</span>:<span style=color:#e6db74>&#34;reset&#34;</span>,<span style=color:#f92672>&#34;pt&#34;</span>:<span style=color:#e6db74>&#34;msg&#34;</span>,<span style=color:#f92672>&#34;to&#34;</span>:<span style=color:#e6db74>&#34;true&#34;</span>,<span style=color:#f92672>&#34;tot&#34;</span>:<span style=color:#e6db74>&#34;bool&#34;</span>}],<span style=color:#f92672>&#34;action&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;property&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;from&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;to&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;reg&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>380</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>280</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[[<span style=color:#e6db74>&#34;d59925e4.632f2&#34;</span>]]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;1aa0cdfe.eb810a&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;comment&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;sequr.be&#34;</span>,<span style=color:#f92672>&#34;info&#34;</span>:<span style=color:#e6db74>&#34;More information on this flow can be found at https://sequr.be/blog/2021/05/home-automation-automating-my-lights-at-the-toilet-room/&#34;</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>160</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>320</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;2ce15169.23b9de&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;server&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Home Assistant&#34;</span>,<span style=color:#f92672>&#34;legacy&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;addon&#34;</span>:<span style=color:#66d9ef>true</span>,<span style=color:#f92672>&#34;rejectUnauthorizedCerts&#34;</span>:<span style=color:#66d9ef>true</span>,<span style=color:#f92672>&#34;ha_boolean&#34;</span>:<span style=color:#e6db74>&#34;y|yes|true|on|home|open&#34;</span>,<span style=color:#f92672>&#34;connectionDelay&#34;</span>:<span style=color:#66d9ef>true</span>,<span style=color:#f92672>&#34;cacheJson&#34;</span>:<span style=color:#66d9ef>true</span>}]
</span></span></code></pre></div><h2 id=the-twist>The twist</h2><p>As I alluded to a few times, I also added a little <em>twist</em> to my flow.</p><p>Can you figure out from the screenshot below what I did? ;)</p><figure class=center><img src=nodered-toilet_lamp_timer.png alt="Node-RED flow for toilet room timer"><figcaption class=center>Let people know they&rsquo;ve been pooping too long :D</figcaption></figure><p><strong>Spoiler</strong><br>When the light in the toilet room has been on for 15 minutes the light is toggled shortly as some sort of hint to the person sitting on the toilet.<br>Time to put away the smartphone/book/&mldr; and get back to business ;)</p><p>Here&rsquo;s the JSON code for this flow:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>[{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;770017d9.000b48&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;server-state-changed&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Light on&#34;</span>,<span style=color:#f92672>&#34;server&#34;</span>:<span style=color:#e6db74>&#34;2ce15169.23b9de&#34;</span>,<span style=color:#f92672>&#34;version&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;exposeToHomeAssistant&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;haConfig&#34;</span>:[{<span style=color:#f92672>&#34;property&#34;</span>:<span style=color:#e6db74>&#34;name&#34;</span>,<span style=color:#f92672>&#34;value&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>},{<span style=color:#f92672>&#34;property&#34;</span>:<span style=color:#e6db74>&#34;icon&#34;</span>,<span style=color:#f92672>&#34;value&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>}],<span style=color:#f92672>&#34;entityidfilter&#34;</span>:<span style=color:#e6db74>&#34;light.toilet_lamp&#34;</span>,<span style=color:#f92672>&#34;entityidfiltertype&#34;</span>:<span style=color:#e6db74>&#34;exact&#34;</span>,<span style=color:#f92672>&#34;outputinitially&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;state_type&#34;</span>:<span style=color:#e6db74>&#34;habool&#34;</span>,<span style=color:#f92672>&#34;haltifstate&#34;</span>:<span style=color:#e6db74>&#34;true&#34;</span>,<span style=color:#f92672>&#34;halt_if_type&#34;</span>:<span style=color:#e6db74>&#34;bool&#34;</span>,<span style=color:#f92672>&#34;halt_if_compare&#34;</span>:<span style=color:#e6db74>&#34;is&#34;</span>,<span style=color:#f92672>&#34;outputs&#34;</span>:<span style=color:#ae81ff>2</span>,<span style=color:#f92672>&#34;output_only_on_state_change&#34;</span>:<span style=color:#66d9ef>true</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>100</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>60</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[[<span style=color:#e6db74>&#34;f9c49225.ef2f98&#34;</span>],[]]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;f9c49225.ef2f98&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;stoptimer&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;duration&#34;</span>:<span style=color:#e6db74>&#34;15&#34;</span>,<span style=color:#f92672>&#34;units&#34;</span>:<span style=color:#e6db74>&#34;Minute&#34;</span>,<span style=color:#f92672>&#34;payloadtype&#34;</span>:<span style=color:#e6db74>&#34;num&#34;</span>,<span style=color:#f92672>&#34;payloadval&#34;</span>:<span style=color:#e6db74>&#34;0&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>300</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>60</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[[],[<span style=color:#e6db74>&#34;8d25fbe6.f8fdc8&#34;</span>]]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;8d25fbe6.f8fdc8&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;api-current-state&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Light still on?&#34;</span>,<span style=color:#f92672>&#34;server&#34;</span>:<span style=color:#e6db74>&#34;2ce15169.23b9de&#34;</span>,<span style=color:#f92672>&#34;version&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;outputs&#34;</span>:<span style=color:#ae81ff>2</span>,<span style=color:#f92672>&#34;halt_if&#34;</span>:<span style=color:#e6db74>&#34;true&#34;</span>,<span style=color:#f92672>&#34;halt_if_type&#34;</span>:<span style=color:#e6db74>&#34;bool&#34;</span>,<span style=color:#f92672>&#34;halt_if_compare&#34;</span>:<span style=color:#e6db74>&#34;is&#34;</span>,<span style=color:#f92672>&#34;override_topic&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;entity_id&#34;</span>:<span style=color:#e6db74>&#34;light.toilet_lamp&#34;</span>,<span style=color:#f92672>&#34;state_type&#34;</span>:<span style=color:#e6db74>&#34;habool&#34;</span>,<span style=color:#f92672>&#34;state_location&#34;</span>:<span style=color:#e6db74>&#34;payload&#34;</span>,<span style=color:#f92672>&#34;override_payload&#34;</span>:<span style=color:#e6db74>&#34;msg&#34;</span>,<span style=color:#f92672>&#34;entity_location&#34;</span>:<span style=color:#e6db74>&#34;data&#34;</span>,<span style=color:#f92672>&#34;override_data&#34;</span>:<span style=color:#e6db74>&#34;msg&#34;</span>,<span style=color:#f92672>&#34;blockInputOverrides&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>510</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>60</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[[<span style=color:#e6db74>&#34;de1a4ca9.6fe9f&#34;</span>],[]]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;5fb82301.096bd4&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;api-call-service&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Light toggle&#34;</span>,<span style=color:#f92672>&#34;server&#34;</span>:<span style=color:#e6db74>&#34;2ce15169.23b9de&#34;</span>,<span style=color:#f92672>&#34;version&#34;</span>:<span style=color:#ae81ff>1</span>,<span style=color:#f92672>&#34;debugenabled&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;service_domain&#34;</span>:<span style=color:#e6db74>&#34;light&#34;</span>,<span style=color:#f92672>&#34;service&#34;</span>:<span style=color:#e6db74>&#34;toggle&#34;</span>,<span style=color:#f92672>&#34;entityId&#34;</span>:<span style=color:#e6db74>&#34;light.toilet_lamp&#34;</span>,<span style=color:#f92672>&#34;data&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;dataType&#34;</span>:<span style=color:#e6db74>&#34;json&#34;</span>,<span style=color:#f92672>&#34;mergecontext&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;output_location&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;output_location_type&#34;</span>:<span style=color:#e6db74>&#34;none&#34;</span>,<span style=color:#f92672>&#34;mustacheAltTags&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>910</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>60</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[[]]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;de1a4ca9.6fe9f&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;trigger&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;0.5s toggle&#34;</span>,<span style=color:#f92672>&#34;op1&#34;</span>:<span style=color:#e6db74>&#34;off&#34;</span>,<span style=color:#f92672>&#34;op2&#34;</span>:<span style=color:#e6db74>&#34;on&#34;</span>,<span style=color:#f92672>&#34;op1type&#34;</span>:<span style=color:#e6db74>&#34;str&#34;</span>,<span style=color:#f92672>&#34;op2type&#34;</span>:<span style=color:#e6db74>&#34;str&#34;</span>,<span style=color:#f92672>&#34;duration&#34;</span>:<span style=color:#e6db74>&#34;500&#34;</span>,<span style=color:#f92672>&#34;extend&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;units&#34;</span>:<span style=color:#e6db74>&#34;ms&#34;</span>,<span style=color:#f92672>&#34;reset&#34;</span>:<span style=color:#e6db74>&#34;&#34;</span>,<span style=color:#f92672>&#34;bytopic&#34;</span>:<span style=color:#e6db74>&#34;all&#34;</span>,<span style=color:#f92672>&#34;topic&#34;</span>:<span style=color:#e6db74>&#34;topic&#34;</span>,<span style=color:#f92672>&#34;outputs&#34;</span>:<span style=color:#ae81ff>2</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>710</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>60</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[[<span style=color:#e6db74>&#34;5fb82301.096bd4&#34;</span>],[<span style=color:#e6db74>&#34;5fb82301.096bd4&#34;</span>,<span style=color:#e6db74>&#34;d4adc37e.d3099&#34;</span>]]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;fe70c04d.b3e158&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;link in&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Reset&#34;</span>,<span style=color:#f92672>&#34;links&#34;</span>:[<span style=color:#e6db74>&#34;d4adc37e.d3099&#34;</span>],<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>155</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>100</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[[<span style=color:#e6db74>&#34;f9c49225.ef2f98&#34;</span>]]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;d4adc37e.d3099&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;link out&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Reset&#34;</span>,<span style=color:#f92672>&#34;links&#34;</span>:[<span style=color:#e6db74>&#34;fe70c04d.b3e158&#34;</span>],<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>835</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>100</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;1aa0cdfe.eb810a&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;comment&#34;</span>,<span style=color:#f92672>&#34;z&#34;</span>:<span style=color:#e6db74>&#34;ef850b1b.00efb&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;sequr.be&#34;</span>,<span style=color:#f92672>&#34;info&#34;</span>:<span style=color:#e6db74>&#34;More information on this flow can be found at https://sequr.be/blog/2021/05/home-automation-automating-my-lights-at-the-toilet-room/&#34;</span>,<span style=color:#f92672>&#34;x&#34;</span>:<span style=color:#ae81ff>460</span>,<span style=color:#f92672>&#34;y&#34;</span>:<span style=color:#ae81ff>100</span>,<span style=color:#f92672>&#34;wires&#34;</span>:[]},{<span style=color:#f92672>&#34;id&#34;</span>:<span style=color:#e6db74>&#34;2ce15169.23b9de&#34;</span>,<span style=color:#f92672>&#34;type&#34;</span>:<span style=color:#e6db74>&#34;server&#34;</span>,<span style=color:#f92672>&#34;name&#34;</span>:<span style=color:#e6db74>&#34;Home Assistant&#34;</span>,<span style=color:#f92672>&#34;legacy&#34;</span>:<span style=color:#66d9ef>false</span>,<span style=color:#f92672>&#34;addon&#34;</span>:<span style=color:#66d9ef>true</span>,<span style=color:#f92672>&#34;rejectUnauthorizedCerts&#34;</span>:<span style=color:#66d9ef>true</span>,<span style=color:#f92672>&#34;ha_boolean&#34;</span>:<span style=color:#e6db74>&#34;y|yes|true|on|home|open&#34;</span>,<span style=color:#f92672>&#34;connectionDelay&#34;</span>:<span style=color:#66d9ef>true</span>,<span style=color:#f92672>&#34;cacheJson&#34;</span>:<span style=color:#66d9ef>true</span>}]
</span></span></code></pre></div><p>Note: the In/Out nodes might not be required, as the flow should restart automatically after the light turns on again.</p><hr><p>There you go: we have automated our (toilet room) lights using a motion sensor!</p><p>Liked my automation?
Got ideas for improvements?
Reach out to me on <a href=https://twitter.com/DezeStijn title="@DezeStijn on Twitter" rel=external target=_blank>Twitter</a>!</p></main><hr><footer><div class=footer><p><div class=previous-post><a href="https://dev.sequr.be/blog/2021/04/diy-ambilight-for-your-tv-or-computer-using-a-rpi-and-hyperion/?ref=footer"><span style=font-weight:700>« Previous</span><br>DIY Ambilight for your TV or computer using a RPi...</a><div class=next-post><a href="https://dev.sequr.be/blog/2021/07/add-an-epaper-display-to-your-esp32-waveshare/?ref=footer"><span style=font-weight:700>Next »</span><br>Add an ePaper display to your ESP32 (Waveshare)</a></div></p></div></footer></article></section><aside class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#requirements-shopping-list>Requirements (shopping list)</a></li><li><a href=#install-the-shelly>Install the Shelly</a><ul><li><a href=#wiring>Wiring</a></li><li><a href=#setup-and-adding-to-home-assistant>Setup and adding to Home Assistant</a></li></ul></li><li><a href=#installing-the-aqara-motion-sensor>Installing the Aqara Motion Sensor</a><ul><li><a href=#physical-installation>Physical installation</a></li><li><a href=#setup-and-adding-to-home-assistant-1>Setup and adding to Home Assistant</a><ul><li><a href=#installing-zigbee-home-automation>Installing Zigbee Home Automation</a></li><li><a href=#adding-aqara-motion-sensor-to-zha>Adding Aqara motion sensor to ZHA</a></li></ul></li></ul></li><li><a href=#setting-up-the-node-red-flow>Setting up the Node-RED flow</a></li><li><a href=#the-twist>The twist</a></li></ul></nav></div></aside></div></body></html>