<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head>&lt; <title itemprop=name>Home Assistant Container Part 4: Mosquitto Docker Container :: Sequr (dev)</title>
<script defer language=javascript type=text/javascript src=/js/bundle.min.145453261a7755f5042a854c4213501d215a8fbe34c08d181c40f803f1315e74.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=robots content="noodp, noydir"><meta name=googlebot content="noodp, noydir"><link rel=canonical href=https://dev.sequr.be/blog/automation/ha_container/pt04_mosquitto/ itemprop=url><meta name=url content="https://dev.sequr.be/blog/automation/ha_container/pt04_mosquitto/"><link rel=icon href=favicon.ico><meta itemprop=name content="Home Assistant Container Part 4: Mosquitto Docker Container"><meta itemprop=description content="In this fourth part of the Home Assistant Container series we’ll add the Mosquitto MQTT broker to our setup."><meta itemprop=datePublished content="2022-09-05T00:00:00+00:00"><meta itemprop=dateModified content="2022-09-05T00:00:00+00:00"><meta itemprop=wordCount content="670"><meta itemprop=image content="https://dev.sequr.be/blog/automation/ha_container/pt04_mosquitto/cover.png"><meta itemprop=keywords content="Home Automation,Home Assistant,Container,Docker,Docker-Compose,Mosquitto,MQTT"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dev.sequr.be/blog/automation/ha_container/pt04_mosquitto/cover.png"><meta name=twitter:title content="Home Assistant Container Part 4: Mosquitto Docker Container"><meta name=twitter:description content="In this fourth part of the Home Assistant Container series we’ll add the Mosquitto MQTT broker to our setup."><meta property="og:url" content="https://dev.sequr.be/blog/automation/ha_container/pt04_mosquitto/"><meta property="og:site_name" content="Sequr (dev)"><meta property="og:title" content="Home Assistant Container Part 4: Mosquitto Docker Container"><meta property="og:description" content="In this fourth part of the Home Assistant Container series we’ll add the Mosquitto MQTT broker to our setup."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-09-05T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-05T00:00:00+00:00"><meta property="article:tag" content="Home Automation"><meta property="article:tag" content="Home Assistant"><meta property="article:tag" content="Container"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Docker-Compose"><meta property="article:tag" content="Mosquitto"><meta property="og:image" content="https://dev.sequr.be/blog/automation/ha_container/pt04_mosquitto/cover.png"><meta name=description content="In this fourth part of the Home Assistant Container series we&rsquo;ll add the Mosquitto MQTT broker to our setup."><meta itemprop=description content="In this fourth part of the Home Assistant Container series we&rsquo;ll add the Mosquitto MQTT broker to our setup."><meta property="og:updated_time" content="2022-09-05T00:00:00Z"><link rel=sitemap type=application/xml title=Sitemap href=https://dev.sequr.be/sitemap.xml><meta name=apple-mobile-web-app-title content="Sequr (dev)"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><link type=text/css rel=stylesheet href=/css/bundle.min.94a339836f89f0d25f31980cb6b0631da21e20af128308747ce44e0525eb16ef.css integrity="sha256-lKM5g2+J8NJfMZgMtrBjHaIeIK8Sgwh0fOROBSXrFu8=" crossorigin=anonymous><style>body{--sidebar-bg-color:#202020;--sidebar-img-border-color:#515151;--sidebar-p-color:#909090;--sidebar-h1-color:#FFF;--sidebar-a-color:#FFF;--sidebar-socials-color:#FFF;--text-color:#222;--bkg-color:#FAF9F6;--post-title-color:#303030;--list-color:#5A5A5A;--link-color:#268BD2;--date-color:#515151;--table-border-color:#E5E5E5;--table-stripe-color:#F9F9F9;--code-color:#000;--code-background-color:#E5E5E5;--code-block-color:#FFF;--code-block-background-color:#272822;--moon-sun-color:#FFF;--moon-sun-background-color:#515151}body.dark-theme{--text-color:#EEE;--bkg-color:#121212;--post-title-color:#DBE2E9;--list-color:#9D9D9D;--link-color:#268BD2;--date-color:#9A9A9A;--table-border-color:#515151;--table-stripe-color:#202020;--code-color:#FFF;--code-background-color:#515151;--code-block-color:#FFF;--code-block-background-color:#272822}body{background-color:var(--bkg-color)}</style></head><body><div class=wrapper><aside class=sidebar><div class="container sidebar-sticky"><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg class="moon" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div><div class=sidebar-about><h1 class=brand><a href=https://dev.sequr.be/><img src=logo.png alt="brand image">
</a><a href=https://dev.sequr.be/><h1>Sequr (dev)</h1></a></h1><p class=lead>Dev version of sequr.be. This site may break at any time.</p></div><nav><ul class=sidebar-nav><li class=heading><a href=/about/>About</a></li><li class=heading>Blog</li><li class=heading><a href=/privacy/>Privacy</a></li></ul></nav><a target=_blank class=social title="RSS Feed" href=/posts/index.xml><svg width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg></a><p class=footnote>&copy; 2019
• <a class="p-name u-url" href=https://sequr.be>DezeStijn</a>
• &lt;a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0&lt;/a></p></div></aside><main class="content container"><div class=post><div class=info><h1 class=post-title><a href=https://dev.sequr.be/blog/automation/ha_container/pt04_mosquitto/>Home Assistant Container Part 4: Mosquitto Docker Container</a></h1><div class=headline><div><span>DezeStijn - </span><time datetime=2022-09-05T00:00:00Z class=post-date>September 5, 2022
</time><span>- </span><span class=reading-time><span>4 mins read</span></span></div><ul class=tags><li class="tag-Home Automation"><a href=https://dev.sequr.be/tags/home-automation>Home Automation</a></li><li class="tag-Home Assistant"><a href=https://dev.sequr.be/tags/home-assistant>Home Assistant</a></li><li class=tag-Container><a href=https://dev.sequr.be/tags/container>Container</a></li><li class=tag-Docker><a href=https://dev.sequr.be/tags/docker>Docker</a></li><li class=tag-docker-compose><a href=https://dev.sequr.be/tags/docker-compose>docker-compose</a></li><li class=tag-Mosquitto><a href=https://dev.sequr.be/tags/mosquitto>Mosquitto</a></li><li class=tag-MQTT><a href=https://dev.sequr.be/tags/mqtt>MQTT</a></li></ul></div></div><h2 id=intro>Intro</h2><p>We&rsquo;re continuing where we left off after <a href=https://dev.sequr.be/blog/automation/ha_container/pt03_mariadb_influxdb/ title="Part 3: MariaDB and InfluxDB">Part 3: MariaDB and InfluxDB</a>.
If you don&rsquo;t know what this is all about, make sure you check the <a href=https://dev.sequr.be/blog/automation/ha_container/pt01_installdocker/ title="Part 1: Install Debian, Docker and Portainer">previous</a> <a href=https://dev.sequr.be/blog/automation/ha_container/pt02_hacontainer/ title="Part 2: Home Assistant Container">posts</a>.</p><p>In this Part 4, we&rsquo;ll be adding our first add-on.
The <a href=https://mosquitto.org/ title="Eclipse Mosquitto" target=_blank>Mosquitto</a> MQTT broker will allow us to connect with a wide range of devices and I highly recommend you install it as well.</p><h2 id=install-mosquttio-mqtt-broker>Install Mosquttio MQTT broker</h2><h3 id=docker-compose>Docker-compose</h3><p>As has become our habit so far, we start off by adding some more config to our <code>docker-compose.yaml</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  [<span style=color:#ae81ff>...]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>homeassistant</span>:
</span></span><span style=display:flex><span>    [<span style=color:#ae81ff>...]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>mariadb</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>influxdb</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>mosquitto</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#f92672>mosquitto</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>mosquitto</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>eclipse-mosquitto</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;1883:1883/tcp&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>TZ=Europe/Brussels</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/opt/mosquitto/config:/mosquitto/config</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/opt/mosquitto/data:/mosquitto/data</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/opt/mosquitto/log:/mosquitto/log</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>stdin_open</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>tty</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>We added the <code>stdin_open</code> and <code>tty</code> lines so we can later connect to the terminal of the container to run some commands.</p><p>Note that we also added a <em>dependency</em> on the mosquitto container for our Home Assistant container.
This way our broker is online before Home Assistant starts and we can be confident our connection won&rsquo;t fail.</p><h3 id=mosquittoconf>Mosquitto.conf</h3><p>When we now launch the Mosquitto container using <code>docker-compose up-d</code> the logs will fill with errors about being <code>Unable to open config file /mosquitto/config/mosquitto.conf</code>.
To fix this, we can download the default config file and store it in the newly created config directory.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cd /opt/mosquitto/config/
</span></span><span style=display:flex><span>sudo wget https://raw.githubusercontent.com/eclipse/mosquitto/master/mosquitto.conf
</span></span></code></pre></div><p>We&rsquo;ll make a few changes however.
You can add the following lines at the end of the config file as all settings are commented out (default setting) by default.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano mosquitto.conf
</span></span><span style=display:flex><span><span style=color:#75715e># add the following lines at the end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Listen on port 1883 on all IPv4 interfaces</span>
</span></span><span style=display:flex><span>listener <span style=color:#ae81ff>1883</span>
</span></span><span style=display:flex><span>socket_domain ipv4
</span></span><span style=display:flex><span><span style=color:#75715e># save the in-memory database to disk</span>
</span></span><span style=display:flex><span>persistence true
</span></span><span style=display:flex><span>persistence_location /mosquitto/data/
</span></span><span style=display:flex><span><span style=color:#75715e># Log to stderr and logfile</span>
</span></span><span style=display:flex><span>log_dest stderr
</span></span><span style=display:flex><span>log_dest file /mosquitto/log/mosquitto.log
</span></span><span style=display:flex><span><span style=color:#75715e># Require authentication</span>
</span></span><span style=display:flex><span>allow_anonymous false
</span></span><span style=display:flex><span>password_file /mosquitto/config/mqttuser
</span></span></code></pre></div><h3 id=mosquitto-users>Mosquitto users</h3><p>Next we&rsquo;ll create a user for our Home Assistant instance to connect with the broker.</p><p>Ideally we later create a new user for every device (family).
For example, a user account for our Shelly devices, one for Zigbee2MQTT, etc.</p><p>Run the following command to create a user named <code>homeassistant</code>.
Note that the <code>-c</code> will create a new password file and will overwrite any existing file. So drop this parameter when you want to create a second account.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it mosquitto mosquitto_passwd -c /mosquitto/config/mqttuser homeassistant
</span></span></code></pre></div><p>If you now check the content of the newly created <code>mqttuser</code> file, you&rsquo;ll find your username and hashed password.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>cat /opt/mosquitto/config/mqttuser
</span></span><span style=display:flex><span>homeassistant:$7$101$q7VtJJ/E*******7$1I******************************************b/G**************************************A<span style=color:#f92672>==</span>
</span></span></code></pre></div><h3 id=restart-mosquitto>Restart Mosquitto</h3><p>We can now restart the Mosquitto container so it loads our changes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>docker compose restart mosquitto
</span></span></code></pre></div><p>Our log file should show the Mosquitto container has started.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cat /opt/mosquitto/log/mosquitto.log
</span></span><span style=display:flex><span>1662413136: mosquitto version 2.0.15 starting
</span></span><span style=display:flex><span>1662413136: Config loaded from /mosquitto/config/mosquitto.conf.
</span></span><span style=display:flex><span>1662413136: Opening ipv4 listen socket on port 1883.
</span></span><span style=display:flex><span>1662413136: mosquitto version 2.0.15 running
</span></span></code></pre></div><figure class=center><img src=mosquitto_container.png alt="Screenshot of Portainer showing our running containers"><figcaption class=center>Mosquitto container up and running</figcaption></figure><h2 id=configure-mqtt-in-home-assistant>Configure MQTT in Home Assistant</h2><p>We can now connect Home Assistant to our MQTT broker so it can start subscribing to topics and send messages.
Since there are no other MQTT clients connected yet, Home Assistant won&rsquo;t be addin new devices yet.</p><figure class=center><img src=mqtt-integration.png alt="Set up a new integration - MQTT"><figcaption class=center>Add an MQTT integration</figcaption></figure><p>We add a new MQTT integration to Home Assistant and enter the credentials we set up a minute ago to authenticate.
Make sure you enter the IP address of your Docker system.</p><figure class=center><img src=mqtt-credentials.png alt="Enter MQTT credentials"><figcaption class=center>Enter the creds of our HA MQTT user</figcaption></figure><p>The logs of our MQTT container confirm Home Assistant has successfully connected.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cat /opt/mosquitto/log/mosquitto.log
</span></span><span style=display:flex><span>1662413136: mosquitto version 2.0.15 running
</span></span><span style=display:flex><span>1662414198: New connection from 192.168.10.106:43153 on port 1883.
</span></span><span style=display:flex><span>1662414198: New client connected from 192.168.10.106:43153 as 4atvQWWEyf2XpG3yy0kgOW <span style=color:#f92672>(</span>p1, c1, k60, u<span style=color:#e6db74>&#39;homeassistant&#39;</span><span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>1662414198: Client 4atvQWWEyf2XpG3yy0kgOW disconnected.
</span></span><span style=display:flex><span>1662414198: New connection from 192.168.10.106:39605 on port 1883.
</span></span><span style=display:flex><span>1662414198: New client connected from 192.168.10.106:39605 as 5gNbahjfE5DulEufquYcaa <span style=color:#f92672>(</span>p2, c1, k60, u<span style=color:#e6db74>&#39;homeassistant&#39;</span><span style=color:#f92672>)</span>.
</span></span></code></pre></div><figure class=center><img src=cover.png alt="MQTT integration installed"><figcaption class=center>Our MQTT integration is setup</figcaption></figure><p>We can now add smart devices that communicate over MQTT like my favourite <a href=https://dev.sequr.be/blog/automation/mqtt_getting_started/ title="Getting started with MQTT and Home Assistant (and Shelly)">Shelly</a> devices, or our <a href=https://dev.sequr.be/blog/automation/solis_inverter/ title="Reading Ginlong Solis inverter over serial and importing in Home Assistant over MQTT">Ginlong Solis</a> sensor.</p><p>In <a href=https://dev.sequr.be/blog/automation/ha_container/pt05_nodered/ title="Part 5: Node-RED">the next article</a>, we&rsquo;ll add Node-RED to our setup so we can make some visually appealing automations.</p><hr><div class=footer><a class=previous-post href="https://dev.sequr.be/blog/automation/ha_container/pt03_mariadb_influxdb/?ref=footer"><span style=font-weight:700>« Previous</span><br>Home Assistant Container Part 3: MariaDB and...</a><div class=next-post><a href="https://dev.sequr.be/blog/automation/ha_container/pt05_nodered/?ref=footer"><span style=font-weight:700>Next »</span><br>Home Assistant Container Part 5: Node-RED</a></div></div></div></main><div class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#intro>Intro</a></li><li><a href=#install-mosquttio-mqtt-broker>Install Mosquttio MQTT broker</a><ul><li><a href=#docker-compose>Docker-compose</a></li><li><a href=#mosquittoconf>Mosquitto.conf</a></li><li><a href=#mosquitto-users>Mosquitto users</a></li><li><a href=#restart-mosquitto>Restart Mosquitto</a></li></ul></li><li><a href=#configure-mqtt-in-home-assistant>Configure MQTT in Home Assistant</a></li></ul></nav></div></div></div></body></html>